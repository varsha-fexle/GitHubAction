name: Validate Changes
on:
  pull_request:
    types: [opened]
    branches:
      - master

jobs:
  SFDX-CLI-Deploy:
    runs-on: ubuntu-latest
    steps:
      - run: echo "🐧 GitHub Action running on ${{ runner.os }}"
      - run: echo "🔎 Retrieving ${{ github.ref }} from ${{ github.repository }}."
      - uses: actions/checkout@v2
      - run: npm install sfdx-cli -g
      - run: echo y | sfdx plugins:install sfdx-git-delta

      - name: Authenticate Dev Hub
        run: |
          echo ${{ secrets.DEVHUB_SFDX_URL }} > ./DEVHUB_SFDX_URL.txt
          sfdx force:auth:sfdxurl:store -f ./DEVHUB_SFDX_URL.txt -d -a devhub

      - run: git config remote.origin.fetch '+refs/heads/:refs/remotes/origin/' 
      - run: git fetch --all

      - run: git --no-pager diff --name-status origin/Staging origin/main ":(exclude).github/workflows/push-action-deploy.yml"
      - run: sfdx sgd:source:delta --to origin/Staging --from origin/main --repo . --output . -i .forceignore

      - name: echo "--- package.xml generated with modified metadata ---"
        run: cat package/package.xml 

      - name: echo "--- destructiveChanges.xml generated with deleted metadata ---"
        run: cat destructiveChanges/destructiveChanges.xml

      - name: echo "--- Converts source-formatted files into metadata that you can deploy using Metadata API. ---"
        run: sfdx force:source:convert --manifest=package/package.xml --outputdir=convert

      - name: 'Deploy code LWC Super Batch dev sandbox'
        run: sfdx force:mdapi:deploy --deploydir=convert --testlevel=RunLocalTests -u devhub
        
    run: sfdx force:mdapi:deploy --deploydir=convert --testlevel=RunLocalTests -u devhub
