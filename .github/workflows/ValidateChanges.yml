name: Deploy to Production
on:
  pull_request:
    branches: [master]
    types:
      - closed
    paths:
      - 'force-app/**'

jobs:
  push-to-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install Salesforce CLI
        run: |
          curl -sL https://developer.salesforce.com/media/salesforce-cli/sfdx-cli/channels/stable/sfdx-cli-linux-x64.tar.xz -o sfdx-cli.tar.xz
          mkdir sfdx-cli
          tar xJf sfdx-cli.tar.xz -C sfdx-cli --strip-components 1
          ./sfdx-cli/install

      - name: Authenticate with Auth URL
        run: |
          echo "${{ secrets.DEVHUB_SFDX_URL }}" > auth-url.txt
          AUTH_URL=$(cat auth-url.txt)
          sfdx force:auth:sfdxurl:store -f auth-url.txt -d -a production

      - name: Put changed files into a dir
        run: |
          mkdir changed-sources
          sfdx sgd:source:delta --to HEAD --from HEAD^ --output changed-sources -i .forceignore

      - name: Deploying to production
        run: |
          sfdx force:source:deploy -p "changed-sources/force-app" -u production -l RunLocalTests
