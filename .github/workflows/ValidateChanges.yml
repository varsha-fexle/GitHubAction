name: Deploy to Production
on:
  pull_request:
    branches: [master]
    types:
      - closed
    paths:
      - 'force-app/**'

jobs:
  push-to-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install Salesforce CLI
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
          mkdir sfdx-cli
          tar xJf sfdx-linux-amd64.tar.xz -C sfdx-cli --strip-components 1
          echo "export PATH=$PATH:$PWD/sfdx-cli/bin" >> $GITHUB_ENV

      - name: Authenticate with Auth URL
        run: |
          echo "${{ secrets.DEV_SFDX_URL }}" > auth-url.txt
          AUTH_URL=$(cat auth-url.txt)
          sfdx force:auth:sfdxurl:store -f auth-url.txt -d -a production

      - name: Put changed files into a dir
        run: |
          mkdir changed-sources
          sfdx sgd:source:delta --to HEAD --from HEAD^ --output changed-sources -i .forceignore

      - name: Deploying to production
        run: |
          sfdx force:source:deploy -p "changed-sources/force-app" -u production -l RunLocalTests
