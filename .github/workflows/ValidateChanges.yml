on:
  pull_request:
    branches: [ master ]
    types:
      - closed
    paths:
      - 'force-app/**'
       
jobs:
  push-to-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Install Salesforce CLI
        run: |
          wget https://developer.salesforce.com/media/salesforce-cli/sfdx-linux-amd64.tar.xz
          mkdir sfdx-cli
          tar xJf sfdx-linux-amd64.tar.xz -C sfdx-cli --strip-components 1
          echo 'export PATH=$PATH:$PWD/sfdx-cli/bin' >> $GITHUB_ENV

      - name: 'Put changed files into a dir'
        run: |
          mkdir changed-sources
          sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources -i .forceignore

      - name: 'Deploying to production'
        run: |
          cd changed-sources/force-app
          sfdx force:source:deploy -p . -u devhub -l RunLocalTests
